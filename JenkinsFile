pipeline {
    // 스테이지 별로 다른 거
    agent any

    triggers {
        pollSCM('*/3 * * * *')
    }

    environment {
      AWS_ACCESS_KEY_ID = credentials('awsAccessKeyId')
      AWS_SECRET_ACCESS_KEY = credentials('awsSecretAccessKey')
      AWS_DEFAULT_REGION = 'ap-northeast-2'
      HOME = '.' // Avoid npm root owned
    }

    stage {
    // Repository 다운로드 받음
        stage('Prepare') {
            agent any

            steps {
                echo 'clone Repository'

                git url: 'https://github.com/portuna85/blitz.git',
                    branch: 'master',
                    credentialsId: 'jenkinsforgithub'
            }

            post {
                success {
                    echo 'Repository Cloned 성공 '
                }

                always {
                    echo " I tried... "
                }

                cleanup{
                    echo "After all other post condition"
                }
            }
        }

        stage('Deploy') {
            steps {
                echo 'Deploying'
                sh '''
                aws s3 sync ./ s3://my-blitz
                '''
            }
        }

        post {
            success {
                echo 'Successfully Cloned Repository'

                mail to: 'portuna85@gmail.com',
                     subject: "Deploy Success",
                     body: "Successfully deployed!!"
            }

            failure {
                echo 'Failed :( '

                mail to: 'portuna85@gmail.com',
                     subject: "Deploy FAILED",
                     body: "FAILED deployed!!"
            }
        }
    }
}
